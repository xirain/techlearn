---
title: Linux ç³»ç»Ÿç¼–ç¨‹ä¸è°ƒè¯•å·¥å…·é¢è¯•é¢˜ â€”â€” ä»æ–‡ä»¶ IO åˆ°æ€§èƒ½ç«ç„°å›¾çš„å®æˆ˜é—®ç­”
description: è¦†ç›–æ–‡ä»¶IO(open/read/write/mmap)ã€ä¿¡å·å¤„ç†(sigaction)ã€è¿›ç¨‹æ§åˆ¶(fork/exec/daemon)ã€GDBè°ƒè¯•(æ–­ç‚¹/core dump/å¤šçº¿ç¨‹)ã€Valgrind/ASan/TSanã€strace/perf/ç«ç„°å›¾ã€io_uringï¼Œ25 é“é«˜é¢‘é¢˜é™„å‘½ä»¤é€ŸæŸ¥
date: 2026-02-27
categories: [æ“ä½œç³»ç»Ÿ]
tags: [linux, é¢è¯•, ç³»ç»Ÿç¼–ç¨‹, gdb, valgrind, perf, ç«ç„°å›¾, io_uring, ä¿¡å·, è°ƒè¯•]
---

Linux ç³»ç»Ÿç¼–ç¨‹å’Œè°ƒè¯•èƒ½åŠ›æ˜¯åç«¯/åŸºç¡€æ¶æ„å²—çš„**ç¡¬æ ¸åŠ åˆ†é¡¹**â€”â€”ä¼šå†™ CRUD çš„äººå¾ˆå¤šï¼Œä½†èƒ½ç”¨ strace è¿½é—®é¢˜ã€GDB è°ƒ core dumpã€perf ç”»ç«ç„°å›¾çš„äººï¼Œæ‰æ˜¯å›¢é˜Ÿé‡Œçš„"æ•‘ç«é˜Ÿé•¿"ã€‚

è¿™ç¯‡æ–‡ç« ä»**æ–‡ä»¶ IO â†’ ä¿¡å· â†’ è¿›ç¨‹ â†’ è°ƒè¯• â†’ æ€§èƒ½**äº”æ¡çº¿å±•å¼€ï¼Œæ¯é“é¢˜éƒ½å¸¦**å¯ç›´æ¥è¿è¡Œçš„å‘½ä»¤**ï¼Œå¸®ä½ ä»"ç†è®ºæ´¾"è¿›åŒ–ä¸º"å®æˆ˜æ´¾"ã€‚

> ğŸ“Œ å…³è”é˜…è¯»ï¼š[æ“ä½œç³»ç»Ÿé¢è¯•é¢˜](/techlearn/posts/os-interview) Â· [C++ å¯¹è±¡æ¨¡å‹é¢è¯•é¢˜](/techlearn/posts/cpp-object-model-interview)

------

## ç¬¬ä¸€éƒ¨åˆ†ï¼šæ–‡ä»¶ IO ä¸å†…å­˜æ˜ å°„

### Q1ï¼šopen() è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿå†…æ ¸æ€ä¹ˆç®¡ç† fdï¼Ÿ

**è®°å¿†ç‚¹**ï¼šfd = è¿›ç¨‹æ–‡ä»¶æè¿°ç¬¦è¡¨çš„**æ•°ç»„ä¸‹æ ‡**

```
è¿›ç¨‹ PCB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fd_table[]         â”‚
â”‚ [0] â”€â”€â†’ stdin      â”‚     ç³»ç»Ÿçº§ æ‰“å¼€æ–‡ä»¶è¡¨
â”‚ [1] â”€â”€â†’ stdout     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [2] â”€â”€â†’ stderr     â”‚     â”‚ file å¯¹è±¡     â”‚    inode è¡¨
â”‚ [3] â”€â”€â†’ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚ offset: 1024 â”‚â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [4] â”€â”€â†’ ...        â”‚     â”‚ flags: O_RDWRâ”‚    â”‚ inode  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ ref_count: 2 â”‚    â”‚ size   â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ blocks â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸‰å±‚ç»“æ„**ï¼š

| å±‚çº§ | æ•°æ®ç»“æ„ | ä½œç”¨ |
|------|---------|------|
| è¿›ç¨‹çº§ | `fd_table[]` | æ•°ç»„ä¸‹æ ‡å°±æ˜¯ fdï¼ŒæŒ‡å‘æ‰“å¼€æ–‡ä»¶è¡¨ |
| ç³»ç»Ÿçº§ | `struct file` | è®°å½•åç§»é‡ã€æ‰“å¼€æ¨¡å¼ã€å¼•ç”¨è®¡æ•° |
| æ–‡ä»¶ç³»ç»Ÿçº§ | `struct inode` | æ–‡ä»¶å…ƒæ•°æ®ã€ç£ç›˜å—ä½ç½® |

**é¢è¯•åŠ åˆ†**ï¼š`fork()` åçˆ¶å­è¿›ç¨‹**å…±äº«åŒä¸€ä¸ª `struct file`**ï¼ˆå¼•ç”¨è®¡æ•° +1ï¼‰ï¼Œæ‰€ä»¥åç§»é‡ä¹Ÿå…±äº«ã€‚`dup2()` ä¹Ÿæ˜¯å…±äº«åŒä¸€ä¸ª file å¯¹è±¡ã€‚

---

### Q2ï¼šread/write ä¸ mmap æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä»€ä¹ˆåœºæ™¯ç”¨ mmap æ›´å¥½ï¼Ÿ

**è®°å¿†ç‚¹**ï¼šread/write = **ä¸¤æ¬¡æ‹·è´**ï¼Œmmap = **é›¶æ‹·è´ï¼ˆç”¨æˆ·æ€ç›´æ¥è®¿é—®é¡µç¼“å­˜ï¼‰**

```
read/write æµç¨‹ï¼š                    mmap æµç¨‹ï¼š
ç£ç›˜ â†’ é¡µç¼“å­˜ â†’ ç”¨æˆ·ç¼“å†²åŒº          ç£ç›˜ â†’ é¡µç¼“å­˜ â†â†’ ç”¨æˆ·è™šæ‹Ÿåœ°å€
      æ‹·è´1      æ‹·è´2                     ç›´æ¥æ˜ å°„ï¼Œæ— æ‹·è´

ç”¨æˆ·ç©ºé—´  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              ç”¨æˆ·ç©ºé—´  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ buf[4096]â”‚ â† æ‹·è´2               â”‚ è™šæ‹Ÿåœ°å€  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚   â†• ç›´æ¥  â”‚
å†…æ ¸ç©ºé—´  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              å†…æ ¸ç©ºé—´  â”‚  é¡µç¼“å­˜   â”‚
          â”‚ é¡µç¼“å­˜    â”‚ â† æ‹·è´1               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¯¹æ¯”é€ŸæŸ¥è¡¨**ï¼š

| ç»´åº¦ | read/write | mmap |
|------|-----------|------|
| æ‹·è´æ¬¡æ•° | 2 æ¬¡ | 0 æ¬¡ï¼ˆç¼ºé¡µä¸­æ–­åç›´æ¥æ˜ å°„ï¼‰ |
| ç³»ç»Ÿè°ƒç”¨ | æ¯æ¬¡ read/write éƒ½è¿›å†…æ ¸ | åªåœ¨ mmap/munmap æ—¶è¿›å†…æ ¸ |
| éšæœºè®¿é—® | éœ€è¦ lseek + read | ç›´æ¥æŒ‡é’ˆè¿ç®— |
| é€‚ç”¨åœºæ™¯ | é¡ºåºè¯»å†™ã€å°æ–‡ä»¶ | å¤§æ–‡ä»¶éšæœºè®¿é—®ã€è¿›ç¨‹é—´å…±äº« |
| ç¼ºç‚¹ | é¢‘ç¹ç³»ç»Ÿè°ƒç”¨å¼€é”€ | ç¼ºé¡µä¸­æ–­å¼€é”€ã€ä¿¡å·å¤„ç†å¤æ‚ |

**å®æˆ˜å‘½ä»¤**ï¼š

```bash
# æŸ¥çœ‹è¿›ç¨‹çš„å†…å­˜æ˜ å°„
cat /proc/<pid>/maps

# å…¸å‹ mmap ç”¨æ³•
void *addr = mmap(NULL, file_size, PROT_READ, MAP_PRIVATE, fd, 0);
```

**é¢è¯•åŠ åˆ†**ï¼šæ•°æ®åº“ï¼ˆå¦‚ MongoDB æ—©æœŸç‰ˆæœ¬ï¼‰å’Œæ—¥å¿—ç³»ç»Ÿå¸¸ç”¨ mmapï¼›ä½† mmap çš„**ç¼ºé¡µä¸­æ–­ä¸å¯æ§**ï¼Œå¯¹å»¶è¿Ÿæ•æ„Ÿçš„åœºæ™¯ï¼ˆå¦‚äº¤æ˜“ç³»ç»Ÿï¼‰åè€Œä¸é€‚åˆã€‚

---

### Q3ï¼šO_DIRECT å’Œ O_SYNC åˆ†åˆ«è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

**è®°å¿†ç‚¹**ï¼šO_DIRECT = **ç»•è¿‡é¡µç¼“å­˜**ï¼ŒO_SYNC = **å†™å…¥æŒä¹…åŒ–ä¿è¯**

```
æ™®é€šå†™ï¼š  write() â†’ é¡µç¼“å­˜ â†’ (å¼‚æ­¥åˆ·ç›˜)     â† å¯èƒ½ä¸¢æ•°æ®
O_SYNCï¼š  write() â†’ é¡µç¼“å­˜ â†’ ç«‹å³åˆ·ç›˜        â† ä¿è¯æŒä¹…åŒ–
O_DIRECTï¼šwrite() â†’ ç»•è¿‡é¡µç¼“å­˜ â†’ ç›´æ¥å†™ç£ç›˜  â† åº”ç”¨è‡ªå·±ç®¡ç¼“å­˜
```

| æ ‡å¿— | ç»•è¿‡ç¼“å­˜ | æŒä¹…åŒ–ä¿è¯ | å…¸å‹åœºæ™¯ |
|------|---------|-----------|---------|
| é»˜è®¤ | âœ— | âœ— | æ™®é€šåº”ç”¨ |
| O_SYNC | âœ— | âœ“ | æ•°æ®åº“ WAL |
| O_DIRECT | âœ“ | âœ— | æ•°æ®åº“è‡ªç®¡ç¼“å­˜ |
| O_DIRECT + O_SYNC | âœ“ | âœ“ | æœ€ä¸¥æ ¼çš„æŒä¹…åŒ– |

**é¢è¯•åŠ åˆ†**ï¼šMySQL InnoDB çš„ `innodb_flush_method=O_DIRECT` å°±æ˜¯ç»•è¿‡ OS é¡µç¼“å­˜ï¼Œç”¨è‡ªå·±çš„ Buffer Pool ç®¡ç†ç¼“å­˜ï¼Œé¿å…**åŒé‡ç¼“å­˜**æµªè´¹å†…å­˜ã€‚

---

### Q4ï¼šé›¶æ‹·è´æŠ€æœ¯æœ‰å“ªå‡ ç§ï¼Ÿsendfile å’Œ splice çš„åŒºåˆ«ï¼Ÿ

**è®°å¿†ç‚¹**ï¼šé›¶æ‹·è´ = å‡å°‘ CPU å‚ä¸çš„æ•°æ®æ‹·è´æ¬¡æ•°

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆ4 æ¬¡æ‹·è´ + 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰ï¼š
read():   ç£ç›˜ â†’ å†…æ ¸ç¼“å†² â†’ ç”¨æˆ·ç¼“å†²    2æ¬¡æ‹·è´ + 2æ¬¡åˆ‡æ¢
write():  ç”¨æˆ·ç¼“å†² â†’ Socketç¼“å†² â†’ ç½‘å¡    2æ¬¡æ‹·è´ + 2æ¬¡åˆ‡æ¢

sendfileï¼ˆ2 æ¬¡æ‹·è´ + 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰ï¼š
sendfile(): ç£ç›˜ â†’ å†…æ ¸ç¼“å†² â†’ Socketç¼“å†² â†’ ç½‘å¡
            DMAæ‹·è´   CPUæ‹·è´    DMAæ‹·è´

sendfile + DMA gatherï¼ˆ0 æ¬¡CPUæ‹·è´ï¼‰ï¼š
sendfile(): ç£ç›˜ â†’ å†…æ ¸ç¼“å†² --------â†’ ç½‘å¡
            DMAæ‹·è´   åªä¼ æè¿°ç¬¦  DMA gather
```

**ä¸‰ç§é›¶æ‹·è´æ–¹å¼**ï¼š

| æ–¹å¼ | åŸç† | é™åˆ¶ | å…¸å‹åº”ç”¨ |
|------|------|------|---------|
| mmap + write | æ˜ å°„é¡µç¼“å­˜åˆ°ç”¨æˆ·ç©ºé—´ | ä»æœ‰ 1 æ¬¡ CPU æ‹·è´ | æ•°æ®åº“ |
| sendfile | å†…æ ¸æ€ç›´æ¥ä¼ è¾“ | åªèƒ½ fd â†’ socket | Nginx é™æ€æ–‡ä»¶ |
| splice | ç®¡é“ä¸­è½¬ï¼Œå†…æ ¸æ€ä¼ è¾“ | å¿…é¡»æœ‰ä¸€ç«¯æ˜¯ç®¡é“ | ä»£ç†æœåŠ¡å™¨ |

**å®æˆ˜**ï¼šNginx é…ç½® `sendfile on;` å°±æ˜¯å¯ç”¨ sendfile é›¶æ‹·è´ï¼Œé™æ€æ–‡ä»¶æ€§èƒ½æå‡æ˜¾è‘—ã€‚Kafka ä¹Ÿç”¨ sendfile å®ç°é«˜ååæ¶ˆè´¹ã€‚

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šä¿¡å·å¤„ç†

### Q5ï¼šsignal() å’Œ sigaction() æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä¸ºä»€ä¹ˆæ¨è sigactionï¼Ÿ

**è®°å¿†ç‚¹**ï¼šsignal() = **ä¸å¯é **ï¼Œsigaction() = **å¯æ§ä¸”å¯ç§»æ¤**

| ç»´åº¦ | signal() | sigaction() |
|------|---------|-------------|
| å¤„ç†å‡½æ•°é‡ç½® | æŸäº›ç³»ç»Ÿå¤„ç†åè‡ªåŠ¨é‡ç½®ä¸º SIG_DFL | ä¸ä¼šé‡ç½® |
| ç³»ç»Ÿè°ƒç”¨ä¸­æ–­ | è¡Œä¸ºä¸ç¡®å®šï¼ˆæ˜¯å¦è‡ªåŠ¨é‡å¯ï¼‰ | SA_RESTART å¯æ§åˆ¶ |
| ä¿¡å·å±è”½ | æ— æ³•æŒ‡å®šå¤„ç†æœŸé—´å±è”½çš„ä¿¡å· | sa_mask ç²¾ç¡®æ§åˆ¶ |
| å¯ç§»æ¤æ€§ | ä¸åŒ Unix è¡Œä¸ºä¸åŒ | POSIX æ ‡å‡†ï¼Œè¡Œä¸ºä¸€è‡´ |

```c
// æ¨èå†™æ³•
struct sigaction sa;
sa.sa_handler = handler_func;
sigemptyset(&sa.sa_mask);
sigaddset(&sa.sa_mask, SIGTERM);  // å¤„ç† SIGUSR1 æ—¶å±è”½ SIGTERM
sa.sa_flags = SA_RESTART;         // è¢«ä¸­æ–­çš„ç³»ç»Ÿè°ƒç”¨è‡ªåŠ¨é‡å¯
sigaction(SIGUSR1, &sa, NULL);
```

**é¢è¯•åŠ åˆ†**ï¼šæ°¸è¿œä¸è¦åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­è°ƒç”¨**éå¼‚æ­¥ä¿¡å·å®‰å…¨**çš„å‡½æ•°ï¼ˆå¦‚ `printf`ã€`malloc`ï¼‰ã€‚å®‰å…¨çš„åšæ³•æ˜¯è®¾ç½®ä¸€ä¸ª `volatile sig_atomic_t` æ ‡å¿—ä½ï¼Œä¸»å¾ªç¯ä¸­æ£€æŸ¥ã€‚

---

### Q6ï¼šSIGCHLD ä¿¡å·æœ‰ä»€ä¹ˆç”¨ï¼Ÿä¸å¤„ç†ä¼šæ€æ ·ï¼Ÿ

**è®°å¿†ç‚¹**ï¼šä¸å¤„ç† SIGCHLD â†’ å­è¿›ç¨‹å˜**åƒµå°¸è¿›ç¨‹**

```
çˆ¶è¿›ç¨‹ fork() å­è¿›ç¨‹ï¼š

å­è¿›ç¨‹é€€å‡ºåï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çˆ¶è¿›ç¨‹    â”‚  ä¸è°ƒç”¨ wait   â”‚ å­è¿›ç¨‹(åƒµå°¸)  â”‚
â”‚ running  â”‚ â†â”€â”€ SIGCHLD â”€â”€â”‚ Z (zombie)   â”‚
â”‚          â”‚                â”‚ åªå‰© PCB å ä½ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­£ç¡®åšæ³•ï¼š
signal(SIGCHLD, SIG_IGN);       // æ–¹å¼1ï¼šå¿½ç•¥ï¼Œå†…æ ¸è‡ªåŠ¨å›æ”¶
// æˆ–
sigaction ä¸­ç”¨ SA_NOCLDWAIT     // æ–¹å¼2ï¼šä¸äº§ç”Ÿåƒµå°¸
// æˆ–
void handler(int sig) {         // æ–¹å¼3ï¼šåœ¨å¤„ç†å‡½æ•°ä¸­å¾ªç¯ waitpid
    while (waitpid(-1, NULL, WNOHANG) > 0);
}
```

**ä¸ºä»€ä¹ˆ waitpid è¦ç”¨å¾ªç¯ï¼Ÿ** å› ä¸ºä¿¡å·ä¸æ’é˜Ÿâ€”â€”å¤šä¸ªå­è¿›ç¨‹åŒæ—¶é€€å‡ºæ—¶ï¼ŒSIGCHLD å¯èƒ½åªæ”¶åˆ°ä¸€æ¬¡ã€‚å¾ªç¯ waitpid ç¡®ä¿å›æ”¶æ‰€æœ‰å·²é€€å‡ºå­è¿›ç¨‹ã€‚

---

### Q7ï¼šå¦‚ä½•ä¼˜é›…åœ°å…³é—­ä¸€ä¸ªå¤šçº¿ç¨‹æœåŠ¡ï¼Ÿ

**è®°å¿†ç‚¹**ï¼š**ä¸“ç”¨ä¿¡å·çº¿ç¨‹ + å…¨å±€æ ‡å¿—ä½ + æœ‰åºæ¸…ç†**

```
ä¸»çº¿ç¨‹å¯åŠ¨æ—¶ï¼š
1. é˜»å¡æ‰€æœ‰å·¥ä½œçº¿ç¨‹çš„ SIGTERM/SIGINTï¼ˆpthread_sigmaskï¼‰
2. åˆ›å»ºä¸“ç”¨ä¿¡å·çº¿ç¨‹ï¼ˆsigwait ç­‰å¾…ä¿¡å·ï¼‰

æ”¶åˆ° SIGTERMï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     è®¾ç½®æ ‡å¿—      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¿¡å·çº¿ç¨‹     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚ g_running=0  â”‚
â”‚ sigwait()   â”‚                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
                                         â†“
                              å„å·¥ä½œçº¿ç¨‹æ£€æŸ¥æ ‡å¿—
                              â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”
                              â”‚ T1â”‚ â”‚ T2â”‚ â”‚ T3â”‚
                              â””â”€â”¬â”€â”˜ â””â”€â”¬â”€â”˜ â””â”€â”¬â”€â”˜
                                â†“     â†“     â†“
                              å®Œæˆå½“å‰ä»»åŠ¡åé€€å‡º
                                â†“     â†“     â†“
                              pthread_join ç­‰å¾…å…¨éƒ¨é€€å‡º
                                      â†“
                              å…³é—­æ–‡ä»¶/é‡Šæ”¾èµ„æº/é€€å‡º
```

```c
// å…³é”®ä»£ç éª¨æ¶
volatile sig_atomic_t g_running = 1;

void* signal_thread(void* arg) {
    sigset_t set;
    sigemptyset(&set);
    sigaddset(&set, SIGTERM);
    sigaddset(&set, SIGINT);
    int sig;
    sigwait(&set, &sig);  // é˜»å¡ç­‰å¾…
    g_running = 0;        // é€šçŸ¥æ‰€æœ‰å·¥ä½œçº¿ç¨‹
    return NULL;
}
```

**é¢è¯•åŠ åˆ†**ï¼šè¿™å°±æ˜¯ Nginx çš„ä¼˜é›…é€€å‡ºæ–¹å¼â€”â€”master è¿›ç¨‹æ”¶åˆ°ä¿¡å·åï¼Œç»™ worker è¿›ç¨‹å‘ SIGQUITï¼Œworker å¤„ç†å®Œå½“å‰è¯·æ±‚åé€€å‡ºã€‚

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¿›ç¨‹æ§åˆ¶

### Q8ï¼šfork() ä¹‹åï¼Œçˆ¶å­è¿›ç¨‹çš„å†…å­˜æ˜¯å¦‚ä½•å…±äº«çš„ï¼Ÿ

**è®°å¿†ç‚¹**ï¼šfork() ç”¨ **COWï¼ˆCopy-On-Writeï¼‰**ï¼Œä¸æ˜¯çœŸçš„å¤åˆ¶

```
fork() åˆšå®Œæˆæ—¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çˆ¶è¿›ç¨‹      â”‚          â”‚ å­è¿›ç¨‹      â”‚
â”‚ é¡µè¡¨ â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”  â”Œâ”€â”€â”¼â”€â”€ é¡µè¡¨     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“  â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ ç‰©ç†é¡µé¢   â”‚  â† ä¸¤ä¸ªé¡µè¡¨æŒ‡å‘åŒä¸€ç‰©ç†é¡µ
            â”‚ (åªè¯»æ ‡è®°) â”‚     ä»»ä½•ä¸€æ–¹å†™å…¥æ—¶è§¦å‘ COW
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å­è¿›ç¨‹å†™å…¥ page A åï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çˆ¶è¿›ç¨‹      â”‚          â”‚ å­è¿›ç¨‹      â”‚
â”‚ é¡µA â†’ åŸé¡µ  â”‚          â”‚ é¡µA â†’ æ–°é¡µ  â”‚  â† åªå¤åˆ¶è¢«ä¿®æ”¹çš„é¡µ
â”‚ é¡µB â†’ å…±äº«  â”‚          â”‚ é¡µB â†’ å…±äº«  â”‚  â† æœªä¿®æ”¹çš„ç»§ç»­å…±äº«
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**COW çš„å¥½å¤„**ï¼š
- `fork() + exec()` æ¨¡å¼ä¸‹ï¼Œå­è¿›ç¨‹é©¬ä¸Šæ›¿æ¢åœ°å€ç©ºé—´ï¼ŒCOW é¿å…äº†æ— ç”¨çš„å†…å­˜å¤åˆ¶
- åªæœ‰**å®é™…å†™å…¥çš„é¡µ**æ‰ä¼šå¤åˆ¶ï¼Œå¤§å¹…èŠ‚çœå†…å­˜

**é¢è¯•åŠ åˆ†**ï¼šRedis çš„ `BGSAVE` å°±åˆ©ç”¨äº† COWâ€”â€”fork å‡ºå­è¿›ç¨‹åš RDB å¿«ç…§ï¼Œçˆ¶è¿›ç¨‹ç»§ç»­æœåŠ¡ã€‚å¦‚æœçˆ¶è¿›ç¨‹å†™å…¥å¯†é›†ï¼ŒCOW ä¼šå¯¼è‡´å¤§é‡é¡µå¤åˆ¶ï¼Œå†…å­˜å¯èƒ½ç¿»å€ã€‚æ‰€ä»¥ Redis å»ºè®®é¢„ç•™ 50% å†…å­˜ç»™ COWã€‚

---

### Q9ï¼šexec å®¶æ—å‡½æ•°æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿæ€ä¹ˆè®°ï¼Ÿ

**è®°å¿†ç‚¹**ï¼š**l/v = å‚æ•°å½¢å¼ï¼Œe = ç¯å¢ƒå˜é‡ï¼Œp = PATH æœç´¢**

```
exec å®¶æ—å‘½åè§„åˆ™ï¼š
exec + [l|v] + [p] + [e]

l = list     å‚æ•°é€ä¸ªåˆ—å‡º   execl(path, arg0, arg1, NULL)
v = vector   å‚æ•°ç”¨æ•°ç»„     execv(path, argv[])
p = PATH     æœç´¢ PATH      execlp("ls", "ls", "-l", NULL)
e = environ  è‡ªå®šä¹‰ç¯å¢ƒå˜é‡  execle(path, arg0, NULL, envp[])
```

| å‡½æ•° | å‚æ•°å½¢å¼ | æœç´¢ PATH | è‡ªå®šä¹‰ç¯å¢ƒ |
|------|---------|----------|-----------|
| `execl` | list | âœ— | âœ— |
| `execv` | vector | âœ— | âœ— |
| `execlp` | list | âœ“ | âœ— |
| `execvp` | vector | âœ“ | âœ— |
| `execle` | list | âœ— | âœ“ |
| `execve` | vector | âœ— | âœ“ï¼ˆå”¯ä¸€ç³»ç»Ÿè°ƒç”¨ï¼‰ |

**é¢è¯•åŠ åˆ†**ï¼šåªæœ‰ `execve` æ˜¯çœŸæ­£çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶ä»–éƒ½æ˜¯ C åº“çš„å°è£…ã€‚

---

### Q10ï¼šå¦‚ä½•å†™ä¸€ä¸ª daemon è¿›ç¨‹ï¼Ÿæ¯ä¸€æ­¥çš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ

**è®°å¿†ç‚¹**ï¼š**åŒ fork + setsid + é‡å®šå‘ fd**

```
æ­¥éª¤ä¸åŸå› ï¼š

1. fork() + çˆ¶è¿›ç¨‹é€€å‡º
   â””â†’ å­è¿›ç¨‹ä¸æ˜¯è¿›ç¨‹ç»„ç»„é•¿ï¼Œæ‰èƒ½è°ƒç”¨ setsid()

2. setsid()
   â””â†’ åˆ›å»ºæ–°ä¼šè¯ï¼Œè„±ç¦»æ§åˆ¶ç»ˆç«¯

3. å†æ¬¡ fork() + çˆ¶è¿›ç¨‹é€€å‡º
   â””â†’ ä¸æ˜¯ä¼šè¯é¦–è¿›ç¨‹ï¼Œæ°¸è¿œä¸ä¼šè·å–æ§åˆ¶ç»ˆç«¯

4. chdir("/")
   â””â†’ é¿å…å ç”¨æŒ‚è½½ç‚¹ï¼Œå¯¼è‡´æ— æ³• umount

5. umask(0)
   â””â†’ ä¸ç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ–‡ä»¶åˆ›å»ºæ©ç 

6. å…³é—­æ‰€æœ‰ fd / é‡å®šå‘ 0,1,2 åˆ° /dev/null
   â””â†’ è„±ç¦»ç»ˆç«¯ï¼Œé¿å…å‘å·²å…³é—­çš„ç»ˆç«¯å†™å…¥
```

```c
void daemonize() {
    pid_t pid = fork();
    if (pid > 0) exit(0);           // çˆ¶è¿›ç¨‹é€€å‡º
    setsid();                        // æ–°ä¼šè¯
    pid = fork();
    if (pid > 0) exit(0);           // å†æ¬¡ fork
    chdir("/");
    umask(0);
    // é‡å®šå‘æ ‡å‡†IO
    int fd = open("/dev/null", O_RDWR);
    dup2(fd, STDIN_FILENO);
    dup2(fd, STDOUT_FILENO);
    dup2(fd, STDERR_FILENO);
    if (fd > 2) close(fd);
}
```

**é¢è¯•åŠ åˆ†**ï¼šç°ä»£ Linux ç”¨ systemd ç®¡ç†å®ˆæŠ¤è¿›ç¨‹ï¼Œä¸éœ€è¦æ‰‹åŠ¨ daemonizeã€‚systemd æä¾›äº†æ—¥å¿—ï¼ˆjournaldï¼‰ã€è‡ªåŠ¨é‡å¯ã€ä¾èµ–ç®¡ç†ç­‰åŠŸèƒ½ã€‚ä½†é¢è¯•è€ƒçš„æ˜¯ä½ **ç†è§£æ¯ä¸€æ­¥çš„åŸå› **ã€‚

---

## ç¬¬å››éƒ¨åˆ†ï¼šGDB è°ƒè¯•

### Q11ï¼šGDB è°ƒè¯•çš„æ ¸å¿ƒå‘½ä»¤é€ŸæŸ¥è¡¨ï¼Ÿ

**è®°å¿†ç‚¹**ï¼š**æ–­ç‚¹â†’è¿è¡Œâ†’æŸ¥çœ‹â†’å¯¼èˆªâ†’ä¿®æ”¹**äº”ç±»å‘½ä»¤

```
å¯åŠ¨ä¸é™„åŠ ï¼š
  gdb ./program              # è°ƒè¯•å¯æ‰§è¡Œæ–‡ä»¶
  gdb -p <pid>               # é™„åŠ åˆ°è¿è¡Œä¸­çš„è¿›ç¨‹
  gdb ./program core         # åˆ†æ core dump
  gdb -tui ./program         # TUI æ¨¡å¼ï¼ˆå¸¦æºç çª—å£ï¼‰

æ–­ç‚¹ç®¡ç†ï¼š
  b main                     # å‡½æ•°æ–­ç‚¹
  b file.c:42                # è¡Œå·æ–­ç‚¹
  b func if x > 10           # æ¡ä»¶æ–­ç‚¹
  watch var                  # ç›‘è§†ç‚¹ï¼ˆå˜é‡å˜åŒ–æ—¶åœï¼‰
  catch throw                # æ•è· C++ å¼‚å¸¸æŠ›å‡º
  info b                     # æŸ¥çœ‹æ‰€æœ‰æ–­ç‚¹
  delete 2                   # åˆ é™¤ 2 å·æ–­ç‚¹
  disable/enable 3           # ç¦ç”¨/å¯ç”¨æ–­ç‚¹

è¿è¡Œæ§åˆ¶ï¼š
  r [args]                   # è¿è¡Œ
  c                          # ç»§ç»­
  n                          # å•æ­¥ï¼ˆä¸è¿›å…¥å‡½æ•°ï¼‰
  s                          # å•æ­¥ï¼ˆè¿›å…¥å‡½æ•°ï¼‰
  fin                        # æ‰§è¡Œåˆ°å½“å‰å‡½æ•°è¿”å›
  until 50                   # æ‰§è¡Œåˆ°ç¬¬ 50 è¡Œ

æŸ¥çœ‹ä¿¡æ¯ï¼š
  p var                      # æ‰“å°å˜é‡
  p/x var                    # åå…­è¿›åˆ¶æ˜¾ç¤º
  p *arr@10                  # æ‰“å°æ•°ç»„å‰ 10 ä¸ªå…ƒç´ 
  bt                         # è°ƒç”¨æ ˆ
  bt full                    # è°ƒç”¨æ ˆ + å±€éƒ¨å˜é‡
  frame 3                    # åˆ‡æ¢åˆ° 3 å·æ ˆå¸§
  info locals                # å½“å‰å‡½æ•°å±€éƒ¨å˜é‡
  info threads               # æ‰€æœ‰çº¿ç¨‹
  thread 2                   # åˆ‡æ¢åˆ° 2 å·çº¿ç¨‹

å†…å­˜æŸ¥çœ‹ï¼š
  x/16xb &var                # 16 å­—èŠ‚ï¼Œåå…­è¿›åˆ¶
  x/4xw &var                 # 4 ä¸ª wordï¼Œåå…­è¿›åˆ¶
  x/s str                    # å­—ç¬¦ä¸²
  x/10i $pc                  # åæ±‡ç¼– 10 æ¡æŒ‡ä»¤
```

---

### Q12ï¼šç¨‹åºå´©æºƒäº†ï¼Œå¦‚ä½•ç”¨ core dump + GDB å®šä½é—®é¢˜ï¼Ÿ

**è®°å¿†ç‚¹**ï¼š**å¼€å¯ core â†’ å¤ç°å´©æºƒ â†’ bt çœ‹æ ˆ â†’ frame çœ‹å˜é‡**

```
æ­¥éª¤ 1ï¼šå¼€å¯ core dump
  ulimit -c unlimited                    # å…è®¸ç”Ÿæˆ core
  echo "/tmp/core.%e.%p" > /proc/sys/kernel/core_pattern

æ­¥éª¤ 2ï¼šå¤ç°å´©æºƒï¼Œç”Ÿæˆ core æ–‡ä»¶

æ­¥éª¤ 3ï¼šGDB åˆ†æ
  gdb ./myprogram /tmp/core.myprogram.12345
  (gdb) bt                               # çœ‹å´©æºƒæ—¶çš„è°ƒç”¨æ ˆ
  #0  0x004005a3 in process_data (ptr=0x0) at main.c:42
  #1  0x004005f1 in handle_request (req=0x7fff...) at server.c:88
  #2  0x00400634 in main () at server.c:120

  (gdb) frame 0                          # åˆ‡åˆ°å´©æºƒå¸§
  (gdb) p ptr                            # çœ‹å˜é‡å€¼
  $1 = (char *) 0x0                      # â†’ ç©ºæŒ‡é’ˆï¼
  (gdb) list                             # çœ‹æºç ä¸Šä¸‹æ–‡
```

**å¸¸è§å´©æºƒåŸå› é€ŸæŸ¥**ï¼š

| ä¿¡å· | å«ä¹‰ | å¸¸è§åŸå›  |
|------|------|---------|
| SIGSEGV | æ®µé”™è¯¯ | ç©ºæŒ‡é’ˆã€é‡æŒ‡é’ˆã€æ ˆæº¢å‡º |
| SIGABRT | ä¸»åŠ¨ç»ˆæ­¢ | assert å¤±è´¥ã€double free |
| SIGFPE | ç®—æœ¯é”™è¯¯ | é™¤ä»¥é›¶ã€æ•´æ•°æº¢å‡º |
| SIGBUS | æ€»çº¿é”™è¯¯ | æœªå¯¹é½è®¿é—®ã€mmap æ–‡ä»¶è¢«æˆªæ–­ |

**é¢è¯•åŠ åˆ†**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®ç”¨ `coredumpctl`ï¼ˆsystemdï¼‰ç®¡ç† core dumpï¼Œå¸¦è‡ªåŠ¨å‹ç¼©å’Œä¿ç•™ç­–ç•¥ã€‚

---

### Q13ï¼šå¦‚ä½•ç”¨ GDB è°ƒè¯•å¤šçº¿ç¨‹ç¨‹åºï¼Ÿæ€ä¹ˆæ’æŸ¥æ­»é”ï¼Ÿ

**è®°å¿†ç‚¹**ï¼š**info threads â†’ thread apply all bt â†’ çœ‹é”çŠ¶æ€**

```
å¤šçº¿ç¨‹è°ƒè¯•å‘½ä»¤ï¼š
  info threads                      # æŸ¥çœ‹æ‰€æœ‰çº¿ç¨‹
  thread 2                          # åˆ‡æ¢åˆ°çº¿ç¨‹ 2
  thread apply all bt               # æ‰€æœ‰çº¿ç¨‹çš„è°ƒç”¨æ ˆï¼ˆæ’æŸ¥æ­»é”ç¥å™¨ï¼‰
  set scheduler-locking on          # åªè¿è¡Œå½“å‰çº¿ç¨‹ï¼ˆé¿å…å…¶ä»–çº¿ç¨‹å¹²æ‰°ï¼‰

æ­»é”æ’æŸ¥æµç¨‹ï¼š
  (gdb) thread apply all bt

  Thread 2 (LWP 12346):
  #0  __lll_lock_wait ()            â† å¡åœ¨é”ä¸Š
  #1  pthread_mutex_lock ()
  #2  transfer (from=A, to=B)       â† çº¿ç¨‹2: æŒæœ‰é”A, ç­‰å¾…é”B

  Thread 1 (LWP 12345):
  #0  __lll_lock_wait ()            â† ä¹Ÿå¡åœ¨é”ä¸Š
  #1  pthread_mutex_lock ()
  #2  transfer (from=B, to=A)       â† çº¿ç¨‹1: æŒæœ‰é”B, ç­‰å¾…é”A

  â†’ ç»å…¸çš„ ABBA æ­»é”ï¼
```

**ä¸ç”¨ GDB çš„å¿«é€Ÿæ’æŸ¥**ï¼š

```bash
# æ–¹å¼1ï¼špstackï¼ˆç”Ÿäº§ç¯å¢ƒå¸¸ç”¨ï¼‰
pstack <pid>

# æ–¹å¼2ï¼šgdb ä¸€é”®é™„åŠ 
gdb -batch -ex "thread apply all bt" -p <pid>

# æ–¹å¼3ï¼š/proc æŸ¥çœ‹çº¿ç¨‹çŠ¶æ€
ls /proc/<pid>/task/         # æ‰€æœ‰çº¿ç¨‹
cat /proc/<pid>/task/<tid>/status  # çº¿ç¨‹çŠ¶æ€
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šå†…å­˜æ£€æµ‹å·¥å…·

### Q14ï¼šValgrind èƒ½æ£€æµ‹å“ªäº›å†…å­˜é—®é¢˜ï¼Ÿæ€ä¹ˆçœ‹æŠ¥å‘Šï¼Ÿ

**è®°å¿†ç‚¹**ï¼šValgrind = **å†…å­˜é”™è¯¯å…¨å®¶æ¡¶**ï¼Œé€Ÿåº¦æ…¢ 10-50x

```bash
# åŸºæœ¬ç”¨æ³•
valgrind --leak-check=full --show-leak-kinds=all ./myprogram

# å…¸å‹è¾“å‡ºè§£è¯»
==12345== Invalid read of size 4          â† è¶Šç•Œè¯»
==12345==    at 0x4005A3: main (test.c:10)
==12345==  Address 0x5204044 is 0 bytes after a block of size 4 alloc'd
==12345==    at 0x4C2AB80: malloc (vg_replace_malloc.c:299)
==12345==    by 0x400593: main (test.c:8)
```

**Valgrind èƒ½æ£€æµ‹çš„é—®é¢˜**ï¼š

| é—®é¢˜ç±»å‹ | ç¤ºä¾‹ | Valgrind æŠ¥å‘Šå…³é”®è¯ |
|---------|------|-------------------|
| å†…å­˜æ³„æ¼ | malloc åæ²¡ free | "definitely lost" |
| è¶Šç•Œè®¿é—® | æ•°ç»„ä¸‹æ ‡è¶Šç•Œ | "Invalid read/write" |
| ä½¿ç”¨æœªåˆå§‹åŒ– | è¯»å–æœªåˆå§‹åŒ–å˜é‡ | "Conditional jump depends on uninitialised" |
| double free | åŒä¸€å—å†…å­˜ free ä¸¤æ¬¡ | "Invalid free" |
| æ‚¬ç©ºæŒ‡é’ˆ | free åç»§ç»­ä½¿ç”¨ | "Invalid read" + "was freed" |

**æ³„æ¼åˆ†ç±»**ï¼š
- **definitely lost**ï¼šç¡®å®šæ³„æ¼ï¼Œæ²¡æœ‰ä»»ä½•æŒ‡é’ˆæŒ‡å‘
- **indirectly lost**ï¼šè¢« definitely lost çš„å—å¼•ç”¨
- **possibly lost**ï¼šæœ‰å†…éƒ¨æŒ‡é’ˆæŒ‡å‘ï¼Œä½†å¯èƒ½ä¸æ˜¯æœ‰æ„çš„
- **still reachable**ï¼šç¨‹åºé€€å‡ºæ—¶ä»æœ‰æŒ‡é’ˆæŒ‡å‘ï¼ˆé€šå¸¸ä¸ç®—æ³„æ¼ï¼‰

---

### Q15ï¼šASanã€TSanã€MSan åˆ†åˆ«æ£€æµ‹ä»€ä¹ˆï¼Ÿå’Œ Valgrind æ¯”æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ

**è®°å¿†ç‚¹**ï¼šSanitizer = **ç¼–è¯‘æ—¶æ’æ¡©**ï¼Œå¿«ä½†éœ€è¦é‡æ–°ç¼–è¯‘

```bash
# ç¼–è¯‘æ—¶å¼€å¯ï¼ˆGCC/Clang éƒ½æ”¯æŒï¼‰
gcc -fsanitize=address -g test.c    # ASan: åœ°å€é”™è¯¯
gcc -fsanitize=thread -g test.c     # TSan: æ•°æ®ç«äº‰
gcc -fsanitize=memory -g test.c     # MSan: æœªåˆå§‹åŒ–è¯»å–ï¼ˆä»… Clangï¼‰
gcc -fsanitize=undefined -g test.c  # UBSan: æœªå®šä¹‰è¡Œä¸º
```

**å¯¹æ¯”é€ŸæŸ¥è¡¨**ï¼š

| å·¥å…· | æ£€æµ‹å¯¹è±¡ | æ€§èƒ½å¼€é”€ | éœ€è¦é‡ç¼–è¯‘ | ä¼˜åŠ¿ |
|------|---------|---------|-----------|------|
| Valgrind | å†…å­˜é”™è¯¯å…¨å®¶æ¡¶ | 10-50x æ…¢ | ä¸éœ€è¦ | ä¸æ”¹ä»£ç å³å¯ç”¨ |
| ASan | è¶Šç•Œã€UAFã€æ³„æ¼ | 2x æ…¢ | éœ€è¦ | é€Ÿåº¦å¿«ï¼Œé”™è¯¯æè¿°æ¸…æ™° |
| TSan | æ•°æ®ç«äº‰ | 5-15x æ…¢ | éœ€è¦ | å”¯ä¸€å®ç”¨çš„ç«æ€æ£€æµ‹å·¥å…· |
| MSan | æœªåˆå§‹åŒ–å†…å­˜è¯»å– | 3x æ…¢ | éœ€è¦ | Valgrind ä¹Ÿèƒ½åšä½†æ›´æ…¢ |
| UBSan | æ•´æ•°æº¢å‡ºã€ç©ºæŒ‡é’ˆ | å‡ ä¹æ—  | éœ€è¦ | å¼€é”€æå° |

**ASan è¾“å‡ºç¤ºä¾‹**ï¼š

```
=================================================================
==12345==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000000014
READ of size 4 at 0x602000000014 thread T0
    #0 0x4005a3 in main test.c:10
    #1 0x7f... in __libc_start_main

0x602000000014 is located 0 bytes after 4-byte region [0x602000000010,0x602000000014)
allocated by thread T0 here:
    #0 0x7f... in malloc
    #1 0x400593 in main test.c:8
```

**é¢è¯•åŠ åˆ†**ï¼šGoogle å†…éƒ¨æ‰€æœ‰ C++ ä»£ç çš„ CI éƒ½å¼€å¯ ASan + TSanã€‚å»ºè®®æŠŠ `-fsanitize=address,undefined` åŠ åˆ° Debug æ„å»ºçš„é»˜è®¤é€‰é¡¹ä¸­ã€‚

---

## ç¬¬å…­éƒ¨åˆ†ï¼šè¿½è¸ªä¸æ€§èƒ½åˆ†æ

### Q16ï¼šstrace èƒ½åšä»€ä¹ˆï¼Ÿæ€ä¹ˆå¿«é€Ÿå®šä½"ç¨‹åºå¡ä½äº†"çš„é—®é¢˜ï¼Ÿ

**è®°å¿†ç‚¹**ï¼šstrace = **ç³»ç»Ÿè°ƒç”¨è¿½è¸ªå™¨**ï¼Œç¨‹åºå¡ä½æ—¶ç¬¬ä¸€ååº”

```bash
# è¿½è¸ªè¿è¡Œä¸­çš„è¿›ç¨‹
strace -p <pid> -f -t

# å¸¸ç”¨é€‰é¡¹
strace -e trace=file ./prog       # åªçœ‹æ–‡ä»¶ç›¸å…³è°ƒç”¨
strace -e trace=network ./prog    # åªçœ‹ç½‘ç»œç›¸å…³è°ƒç”¨
strace -c ./prog                  # ç»Ÿè®¡å„ç³»ç»Ÿè°ƒç”¨è€—æ—¶
strace -T ./prog                  # æ¯ä¸ªè°ƒç”¨çš„è€—æ—¶
strace -o output.txt ./prog       # è¾“å‡ºåˆ°æ–‡ä»¶
```

**å®æˆ˜ï¼šç¨‹åºå¡ä½äº†**

```bash
$ strace -p 12345
futex(0x7f..., FUTEX_WAIT, ...) = ?    â† å¡åœ¨ futex â†’ é”ç«äº‰/æ­»é”
poll([{fd=3, events=POLLIN}], 1, -1)   â† å¡åœ¨ poll â†’ ç­‰å¾…ç½‘ç»œ/IO
read(0,                                â† å¡åœ¨ read â†’ ç­‰å¾… stdin è¾“å…¥
nanosleep({tv_sec=3600}, ...)          â† å¡åœ¨ sleep â†’ ç¨‹åºåœ¨ sleep
```

**strace -c è¾“å‡º**ï¼ˆæ‰¾æ€§èƒ½ç“¶é¢ˆï¼‰ï¼š

```
% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- --------
 89.42    0.182912          91      2000           write     â† ç“¶é¢ˆï¼
  5.31    0.010862           5      2000           read
  3.12    0.006381           3      2000           open
```

**é¢è¯•åŠ åˆ†**ï¼š`ltrace` è¿½è¸ªçš„æ˜¯**åº“å‡½æ•°è°ƒç”¨**ï¼ˆå¦‚ mallocã€printfï¼‰ï¼Œå’Œ strace äº’è¡¥ã€‚

---

### Q17ï¼šperf å·¥å…·æ€ä¹ˆç”¨ï¼Ÿå¦‚ä½•ç”Ÿæˆç«ç„°å›¾ï¼Ÿ

**è®°å¿†ç‚¹**ï¼šperf = **æ€§èƒ½åˆ†æç‘å£«å†›åˆ€**ï¼Œç«ç„°å›¾ = **å¯è§†åŒ–çƒ­ç‚¹å‡½æ•°**

```bash
# æ­¥éª¤ 1ï¼šé‡‡æ ·
perf record -g -p <pid> -- sleep 30   # é‡‡æ · 30 ç§’
perf record -g ./myprogram            # æˆ–ç›´æ¥è¿è¡Œé‡‡æ ·

# æ­¥éª¤ 2ï¼šæŸ¥çœ‹æŠ¥å‘Š
perf report                            # äº¤äº’å¼æŸ¥çœ‹çƒ­ç‚¹å‡½æ•°

# æ­¥éª¤ 3ï¼šç”Ÿæˆç«ç„°å›¾
perf script > perf.out                 # å¯¼å‡ºé‡‡æ ·æ•°æ®
stackcollapse-perf.pl perf.out > folded.out
flamegraph.pl folded.out > flamegraph.svg
```

**ç«ç„°å›¾æ€ä¹ˆçœ‹**ï¼š

```
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           main()                 â”‚  â† åº•éƒ¨ = è°ƒç”¨è€…
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ process()    â”‚   handle_io()     â”‚  â† å®½åº¦ = CPU å æ¯”
         â”œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
         â”‚sort()â”‚hash() â”‚                   â”‚  â† é¡¶éƒ¨ = å®é™…æ¶ˆè€— CPU çš„å‡½æ•°
         â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çœ‹ç«ç„°å›¾ä¸‰æ­¥æ³•ï¼š
1. æ‰¾æœ€å®½çš„"å¹³é¡¶"ï¼ˆé¡¶éƒ¨å®½ = è¯¥å‡½æ•°è‡ªèº«æ¶ˆè€— CPU å¤šï¼‰
2. çœ‹å®ƒçš„è°ƒç”¨è·¯å¾„ï¼ˆä»ä¸‹å¾€ä¸Šï¼Œç†è§£ä¸ºä»€ä¹ˆè¢«è°ƒç”¨ï¼‰
3. æ€è€ƒèƒ½å¦å‡å°‘è°ƒç”¨æ¬¡æ•°æˆ–ä¼˜åŒ–å‡½æ•°æœ¬èº«
```

**perf å…¶ä»–å¸¸ç”¨å‘½ä»¤**ï¼š

```bash
perf stat ./prog              # æ€»ä½“ç»Ÿè®¡ï¼ˆIPCã€ç¼“å­˜å‘½ä¸­ç‡ç­‰ï¼‰
perf top                      # å®æ—¶çƒ­ç‚¹ï¼ˆç±»ä¼¼ topï¼‰
perf stat -e cache-misses,cache-references ./prog  # ç¼“å­˜å‘½ä¸­åˆ†æ
```

**é¢è¯•åŠ åˆ†**ï¼š`perf stat` è¾“å‡ºçš„ IPCï¼ˆInstructions Per Cycleï¼‰æ˜¯æ€§èƒ½å…³é”®æŒ‡æ ‡â€”â€”IPC < 1 é€šå¸¸æ„å‘³ç€ CPU åœ¨ç­‰å¾…å†…å­˜ï¼ˆcache missï¼‰ï¼ŒIPC > 2 è¯´æ˜æµæ°´çº¿åˆ©ç”¨ç‡é«˜ã€‚

---

### Q18ï¼šå¦‚ä½•ç”¨ perf åˆ†æç¼“å­˜æ€§èƒ½å’Œåˆ†æ”¯é¢„æµ‹ï¼Ÿ

**è®°å¿†ç‚¹**ï¼š**cache miss çœ‹æ•°æ®å±€éƒ¨æ€§ï¼Œbranch miss çœ‹åˆ†æ”¯æ¨¡å¼**

```bash
# ç¼“å­˜åˆ†æ
perf stat -e L1-dcache-loads,L1-dcache-load-misses,\
LLC-loads,LLC-load-misses ./prog

# è¾“å‡ºç¤ºä¾‹
  1,000,000  L1-dcache-loads
    200,000  L1-dcache-load-misses  # L1 å‘½ä¸­ç‡ 80% â† ä¸ç†æƒ³
     50,000  LLC-loads
     10,000  LLC-load-misses        # LLC å‘½ä¸­ç‡ 80%

# åˆ†æ”¯é¢„æµ‹åˆ†æ
perf stat -e branches,branch-misses ./prog

# è¾“å‡ºç¤ºä¾‹
  5,000,000  branches
    500,000  branch-misses          # 10% åˆ†æ”¯é¢„æµ‹å¤±è´¥ â† è¾ƒé«˜
```

**ä¼˜åŒ–æ–¹å‘**ï¼š

| æŒ‡æ ‡ | æ­£å¸¸èŒƒå›´ | é—®é¢˜åŸå›  | ä¼˜åŒ–æ–¹æ³• |
|------|---------|---------|---------|
| L1 cache miss > 5% | < 3% | æ•°æ®å±€éƒ¨æ€§å·® | é‡æ’æ•°æ®ç»“æ„ã€SOA æ›¿ä»£ AOS |
| LLC miss é«˜ | è¶Šä½è¶Šå¥½ | å·¥ä½œé›†å¤ªå¤§ | å‡å°æ•°æ®é‡ã€é¢„å– |
| åˆ†æ”¯é¢„æµ‹å¤±è´¥ > 5% | < 2% | åˆ†æ”¯ä¸å¯é¢„æµ‹ | ç”¨ `__builtin_expect`ã€CMOV |

---

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šè¿›é˜¶å·¥å…·

### Q19ï¼šltraceã€ftraceã€bpftrace å„è‡ªçš„å®šä½æ˜¯ä»€ä¹ˆï¼Ÿ

**è®°å¿†ç‚¹**ï¼š**ç”¨æˆ·æ€åº“ / å†…æ ¸æ€å‡½æ•° / å…¨èƒ½å¯ç¼–ç¨‹**

| å·¥å…· | è¿½è¸ªå±‚ | å…¸å‹ç”¨é€” | æ€§èƒ½å¼€é”€ |
|------|-------|---------|---------|
| strace | ç³»ç»Ÿè°ƒç”¨ | è¿›ç¨‹å¡ä½æ’æŸ¥ | ä¸­ç­‰ |
| ltrace | ç”¨æˆ·æ€åº“å‡½æ•° | çœ‹ malloc/free è°ƒç”¨æ¨¡å¼ | ä¸­ç­‰ |
| ftrace | å†…æ ¸å‡½æ•° | å†…æ ¸è°ƒè¯•ã€è°ƒåº¦åˆ†æ | ä½ |
| bpftrace | å…¨å±‚ï¼ˆeBPFï¼‰ | å¯ç¼–ç¨‹è¿½è¸ªï¼Œå–ä»£ä¸Šé¢æ‰€æœ‰ | æä½ |

**bpftrace ç¤ºä¾‹**ï¼š

```bash
# ç»Ÿè®¡ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°
bpftrace -e 'tracepoint:raw_syscalls:sys_enter { @[comm] = count(); }'

# è¿½è¸ª open() çš„æ–‡ä»¶å
bpftrace -e 'tracepoint:syscalls:sys_enter_openat {
    printf("%s â†’ %s\n", comm, str(args->filename));
}'

# ç»Ÿè®¡ malloc åˆ†é…å¤§å°åˆ†å¸ƒ
bpftrace -e 'uprobe:/lib/x86_64-linux-gnu/libc.so.6:malloc {
    @sizes = hist(arg0);
}'
```

**é¢è¯•åŠ åˆ†**ï¼šeBPF æ˜¯è¿‘å¹´ Linux æœ€é‡è¦çš„æŠ€æœ¯é©æ–°ä¹‹ä¸€â€”â€”å®ƒè®©ä½ åœ¨**å†…æ ¸ä¸­å®‰å…¨åœ°è¿è¡Œè‡ªå®šä¹‰ä»£ç **ï¼Œä¸éœ€è¦å†™å†…æ ¸æ¨¡å—ã€‚Netflixã€Facebookã€Cloudflare éƒ½åœ¨å¤§è§„æ¨¡ä½¿ç”¨ã€‚

---

### Q20ï¼šä»€ä¹ˆæ˜¯ io_uringï¼Ÿå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

**è®°å¿†ç‚¹**ï¼šio_uring = **å¼‚æ­¥ IO + é›¶ç³»ç»Ÿè°ƒç”¨å¼€é”€**

```
ä¼ ç»Ÿ IO æ¨¡å‹çš„é—®é¢˜ï¼š
epoll_wait() â†’ read()  â†’ write() â†’ epoll_wait() â†’ ...
    ç³»ç»Ÿè°ƒç”¨     ç³»ç»Ÿè°ƒç”¨   ç³»ç»Ÿè°ƒç”¨     ç³»ç»Ÿè°ƒç”¨
    æ¯æ¬¡ IO æ“ä½œéƒ½è¦è¿›å‡ºå†…æ ¸ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€å¤§

io_uring æ¨¡å‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å…±äº«å†…å­˜                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ æäº¤é˜Ÿåˆ— SQ   â”‚  â”‚ å®Œæˆé˜Ÿåˆ— CQ   â”‚      â”‚
â”‚  â”‚ (ç”¨æˆ·å†™å…¥)    â”‚  â”‚ (å†…æ ¸å†™å…¥)    â”‚      â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”  â”‚  â”‚ â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”‚      â”‚
â”‚  â”‚ â”‚reqâ”‚ â”‚reqâ”‚  â”‚  â”‚ â”‚resâ”‚ â”‚resâ”‚ â”‚      â”‚
â”‚  â”‚ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜  â”‚  â”‚ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘ ç”¨æˆ·æ€å†™                â†‘ ç”¨æˆ·æ€è¯»
      æ— éœ€ç³»ç»Ÿè°ƒç”¨ï¼             æ— éœ€ç³»ç»Ÿè°ƒç”¨ï¼
```

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š

| ç»´åº¦ | epoll + read/write | io_uring |
|------|-------------------|----------|
| ç³»ç»Ÿè°ƒç”¨ | æ¯æ¬¡ IO è‡³å°‘ 1 æ¬¡ | æ‰¹é‡æäº¤ï¼Œç”šè‡³ 0 æ¬¡ |
| æ•°æ®æ‹·è´ | éœ€è¦ read æ‹·è´æ•°æ® | æ”¯æŒå›ºå®š bufferï¼Œå‡å°‘æ‹·è´ |
| å¼‚æ­¥æ”¯æŒ | read/write ä»æ˜¯åŒæ­¥ | çœŸæ­£çš„å†…æ ¸çº§å¼‚æ­¥ |
| é€‚ç”¨èŒƒå›´ | ç½‘ç»œ IO | ç½‘ç»œ + ç£ç›˜ + å®šæ—¶å™¨ |

**ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µ**ï¼š

| æ¦‚å¿µ | è¯´æ˜ |
|------|------|
| SQE (Submission Queue Entry) | ç”¨æˆ·å¡«å†™çš„ IO è¯·æ±‚ |
| CQE (Completion Queue Entry) | å†…æ ¸è¿”å›çš„ IO ç»“æœ |
| io_uring_setup / io_uring_enter | åˆ›å»º/æäº¤çš„ç³»ç»Ÿè°ƒç”¨ |

```c
// åŸºæœ¬ä½¿ç”¨æµç¨‹
struct io_uring ring;
io_uring_queue_init(32, &ring, 0);

// æäº¤è¯»è¯·æ±‚
struct io_uring_sqe *sqe = io_uring_get_sqe(&ring);
io_uring_prep_read(sqe, fd, buf, size, offset);
io_uring_submit(&ring);

// ç­‰å¾…å®Œæˆ
struct io_uring_cqe *cqe;
io_uring_wait_cqe(&ring, &cqe);
int bytes_read = cqe->res;
io_uring_cqe_seen(&ring, cqe);
```

**é¢è¯•åŠ åˆ†**ï¼šio_uring å·²è¢«åº”ç”¨äº RocksDBã€Nginxï¼ˆå®éªŒæ€§ï¼‰ã€‚åœ¨é«˜ IOPS åœºæ™¯ä¸‹ï¼Œio_uring æ¯” epoll æ€§èƒ½æå‡ 30%+ã€‚

---

## ç¬¬å…«éƒ¨åˆ†ï¼šå®æˆ˜æ’æŸ¥åœºæ™¯

### Q21ï¼šçº¿ä¸ŠæœåŠ¡ CPU 100%ï¼Œæ€ä¹ˆä¸€æ­¥æ­¥æ’æŸ¥ï¼Ÿ

**è®°å¿†ç‚¹**ï¼š**top â†’ çº¿ç¨‹ â†’ æ ˆ â†’ ç«ç„°å›¾**

```
æ’æŸ¥æµç¨‹å›¾ï¼š

å‘ç° CPU 100%
     â”‚
     â†“
top -Hp <pid>  â†â”€â”€ æ‰¾åˆ° CPU æœ€é«˜çš„çº¿ç¨‹ TID
     â”‚
     â†“
printf '%x\n' <tid>  â†â”€â”€ TID è½¬åå…­è¿›åˆ¶
     â”‚
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹å¼1: jstack <pid> (Java)    â”‚
â”‚ æ–¹å¼2: pstack <pid> (C/C++)   â”‚
â”‚ æ–¹å¼3: gdb -batch -ex         â”‚
â”‚   "thread apply all bt" -p    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
         çœ‹çº¿ç¨‹åœ¨å¹²ä»€ä¹ˆ
    â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”
    â†“      â†“      â†“
  ç”¨æˆ·æ€   å†…æ ¸æ€   ç­‰å¾…IO
  æ­»å¾ªç¯   é¢‘ç¹sys  ç£ç›˜æ…¢
    â”‚      â”‚       â”‚
    â†“      â†“       â†“
  perf   strace   iostat
  record  -p pid  -x 1
```

**å®æˆ˜å‘½ä»¤åºåˆ—**ï¼š

```bash
# 1. æ‰¾åˆ° CPU é«˜çš„è¿›ç¨‹
top -c

# 2. æ‰¾åˆ° CPU é«˜çš„çº¿ç¨‹
top -Hp <pid>

# 3. å¿«é€Ÿçœ‹çº¿ç¨‹æ ˆ
pstack <pid>  # æˆ– gdb -batch -ex "thread apply all bt" -p <pid>

# 4. å¦‚æœéœ€è¦æ›´å¤šä¿¡æ¯
perf record -g -p <pid> -- sleep 10
perf report

# 5. ç”Ÿæˆç«ç„°å›¾ç¡®è®¤çƒ­ç‚¹
perf script | stackcollapse-perf.pl | flamegraph.pl > cpu.svg
```

---

### Q22ï¼šçº¿ä¸ŠæœåŠ¡å†…å­˜æŒç»­å¢é•¿ï¼ˆå†…å­˜æ³„æ¼ï¼‰ï¼Œæ€ä¹ˆæ’æŸ¥ï¼Ÿ

**è®°å¿†ç‚¹**ï¼š**ç¡®è®¤å¢é•¿ â†’ åˆ†æåˆ†é… â†’ å®šä½æ³„æ¼ç‚¹**

```bash
# 1. ç¡®è®¤å†…å­˜å¢é•¿è¶‹åŠ¿
pidstat -r -p <pid> 1       # æ¯ç§’çœ‹ RSS å˜åŒ–
watch -n 1 "cat /proc/<pid>/status | grep VmRSS"

# 2. çœ‹å†…å­˜åˆ†é…åœ°å›¾
pmap -x <pid>               # çœ‹å„æ®µå†…å­˜å¤§å°
cat /proc/<pid>/smaps       # è¯¦ç»†å†…å­˜æ˜ å°„

# 3. ä½¿ç”¨ Valgrindï¼ˆå¼€å‘ç¯å¢ƒï¼‰
valgrind --leak-check=full --log-file=leak.txt ./prog

# 4. ä½¿ç”¨ ASanï¼ˆå¼€å‘ç¯å¢ƒï¼Œæ›´å¿«ï¼‰
gcc -fsanitize=address -g prog.c && ./a.out

# 5. ç”Ÿäº§ç¯å¢ƒï¼šjemalloc + prof
LD_PRELOAD=/usr/lib/libjemalloc.so MALLOC_CONF="prof:true,prof_prefix:jeprof" ./prog
jeprof --svg ./prog jeprof.*.heap > heap.svg
```

**å†…å­˜æ³„æ¼æ’æŸ¥å†³ç­–æ ‘**ï¼š

```
å†…å­˜å¢é•¿
  â”œâ”€â”€ RSS å¢é•¿ï¼Œä½† heap ä¸å˜ â†’ mmap æ³„æ¼ï¼ˆæ£€æŸ¥ /proc/pid/mapsï¼‰
  â”œâ”€â”€ heap å¢é•¿
  â”‚   â”œâ”€â”€ malloc æ¬¡æ•° > free æ¬¡æ•° â†’ å¿˜è®°é‡Šæ”¾
  â”‚   â”œâ”€â”€ malloc = free ä½†å†…å­˜ä¸é™ â†’ å†…å­˜ç¢ç‰‡
  â”‚   â””â”€â”€ ç¼“å­˜æ— é™å¢é•¿ â†’ éœ€è¦æ·˜æ±°ç­–ç•¥ï¼ˆLRUï¼‰
  â””â”€â”€ ä¸æ˜¯æ³„æ¼ â†’ ä¸šåŠ¡æ•°æ®æ­£å¸¸å¢é•¿
```

---

### Q23ï¼šç£ç›˜ IO æ…¢ï¼Œå¦‚ä½•å®šä½é—®é¢˜ï¼Ÿ

**è®°å¿†ç‚¹**ï¼š**iostat â†’ å“ªä¸ªç›˜ â†’ å“ªä¸ªè¿›ç¨‹ â†’ è¯»è¿˜æ˜¯å†™**

```bash
# 1. æ•´ä½“ IO çŠ¶å†µ
iostat -xz 1
# å…³æ³¨ï¼š%utilï¼ˆåˆ©ç”¨ç‡ï¼‰ã€awaitï¼ˆç­‰å¾…æ—¶é—´ï¼‰ã€r/s w/sï¼ˆIOPSï¼‰

# å…³é”®æŒ‡æ ‡è§£è¯»
Device   r/s   w/s  rMB/s  wMB/s  await  %util
sda     500   200   50.0   20.0   8.5    95.2   â† ç£ç›˜å‡ ä¹æ‰“æ»¡

# 2. æ‰¾åˆ°å“ªä¸ªè¿›ç¨‹åœ¨åš IO
iotop -oP                    # å®æ—¶çœ‹ IO æ’å
pidstat -d 1                 # æ¯ç§’ç»Ÿè®¡å„è¿›ç¨‹ IO

# 3. çœ‹å…·ä½“åœ¨è¯»å†™ä»€ä¹ˆæ–‡ä»¶
strace -e trace=read,write,open -p <pid>
# æˆ–
lsof -p <pid>                # çœ‹æ‰“å¼€çš„æ–‡ä»¶åˆ—è¡¨

# 4. å¯¹æ¯”é¡ºåº vs éšæœº IO
perf record -e block:block_rq_issue -p <pid>
perf script | sort | uniq -c | sort -rn | head
```

**IO æ€§èƒ½å…³é”®æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | å«ä¹‰ | HDD æ­£å¸¸å€¼ | SSD æ­£å¸¸å€¼ |
|------|------|-----------|-----------|
| await | å¹³å‡ç­‰å¾…æ—¶é—´ | < 20ms | < 2ms |
| %util | ç£ç›˜åˆ©ç”¨ç‡ | < 80% | < 80% |
| IOPS | æ¯ç§’ IO æ¬¡æ•° | 100-200 | 10K-100K |
| åå | MB/s | 100-200 | 500-3000 |

---

## ç¬¬ä¹éƒ¨åˆ†ï¼šLinux ç½‘ç»œè°ƒè¯•

### Q24ï¼šç½‘ç»œä¸é€šæ—¶çš„æ’æŸ¥æ­¥éª¤ï¼Ÿ

**è®°å¿†ç‚¹**ï¼š**åˆ†å±‚æ’æŸ¥ï¼šç‰©ç†â†’é“¾è·¯â†’ç½‘ç»œâ†’ä¼ è¾“â†’åº”ç”¨**

```
æ’æŸ¥å±‚æ¬¡ï¼ˆä»ä¸‹å¾€ä¸Šï¼‰ï¼š

Layer 1-2 ç‰©ç†/é“¾è·¯å±‚ï¼š
  ip link show              # ç½‘å¡æ˜¯å¦ UP
  ethtool eth0              # ç‰©ç†è¿æ¥çŠ¶æ€

Layer 3 ç½‘ç»œå±‚ï¼š
  ip addr show              # IP åœ°å€é…ç½®
  ip route show             # è·¯ç”±è¡¨
  ping <target>             # å¯è¾¾æ€§
  traceroute <target>       # è·¯å¾„è¿½è¸ª
  mtr <target>              # æŒç»­è¿½è¸ªï¼ˆping + tracerouteï¼‰

Layer 4 ä¼ è¾“å±‚ï¼š
  ss -tlnp                  # æŸ¥çœ‹ç›‘å¬ç«¯å£
  ss -tnp                   # æŸ¥çœ‹å·²å»ºç«‹è¿æ¥
  ss -s                     # è¿æ¥ç»Ÿè®¡
  netstat -i                # ç½‘å¡ç»Ÿè®¡ï¼ˆä¸¢åŒ…ç­‰ï¼‰
  iptables -L -n -v         # é˜²ç«å¢™è§„åˆ™

Layer 7 åº”ç”¨å±‚ï¼š
  curl -v <url>             # HTTP è°ƒè¯•
  tcpdump -i eth0 port 80   # æŠ“åŒ…
  wireshark                 # å›¾å½¢åŒ–åˆ†æ
```

---

### Q25ï¼štcpdump æŠ“åŒ…é€ŸæŸ¥å’Œå¸¸è§åˆ†æåœºæ™¯ï¼Ÿ

**è®°å¿†ç‚¹**ï¼štcpdump = **ç½‘ç»œå±‚çš„ strace**

```bash
# åŸºæœ¬ç”¨æ³•
tcpdump -i eth0 -nn                    # ä¸è§£æåŸŸåå’Œç«¯å£å
tcpdump -i eth0 port 80                # æŒ‡å®šç«¯å£
tcpdump -i eth0 host 10.0.0.1          # æŒ‡å®šä¸»æœº
tcpdump -i eth0 'tcp[tcpflags] & tcp-syn != 0'  # åªçœ‹ SYN åŒ…

# ä¿å­˜å’Œåˆ†æ
tcpdump -i eth0 -w capture.pcap        # ä¿å­˜åˆ°æ–‡ä»¶
tcpdump -r capture.pcap                # è¯»å–æ–‡ä»¶
tcpdump -i eth0 -c 100 -w debug.pcap   # åªæŠ“ 100 ä¸ªåŒ…

# å¸¸ç”¨ç»„åˆè¿‡æ»¤
tcpdump -i eth0 'src host 10.0.0.1 and dst port 3306'  # æ¥è‡ªæŸIPåˆ°MySQL
tcpdump -i eth0 'tcp[tcpflags] & (tcp-rst) != 0'       # åªçœ‹ RST åŒ…
```

**å¸¸è§ç½‘ç»œé—®é¢˜ä¸æŠ“åŒ…ç‰¹å¾**ï¼š

| é—®é¢˜ | tcpdump ç‰¹å¾ | æ ¹å›  |
|------|-------------|------|
| è¿æ¥è¶…æ—¶ | åªæœ‰ SYNï¼Œæ²¡æœ‰ SYN-ACK | é˜²ç«å¢™/æœåŠ¡æœªç›‘å¬ |
| è¿æ¥è¢«æ‹’ | SYN â†’ RST | ç«¯å£æœªç›‘å¬ |
| è¿æ¥é‡ç½® | ä¼ è¾“ä¸­å‡ºç° RST | åº”ç”¨å´©æºƒ/é˜²ç«å¢™ |
| é‡ä¼ å¤š | [TCP Retransmission] | ç½‘ç»œä¸¢åŒ… |
| å»¶è¿Ÿé«˜ | SYN åˆ° SYN-ACK æ—¶é—´é•¿ | ç½‘ç»œå»¶è¿Ÿ/æœåŠ¡ç«¯æ…¢ |

---

## å‘½ä»¤é€ŸæŸ¥æ€»è¡¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Linux è°ƒè¯•å·¥å…·é€ŸæŸ¥                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åœºæ™¯          â”‚ å·¥å…· & å‘½ä»¤                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¨‹åºå´©æºƒ      â”‚ gdb + core dump, dmesg                       â”‚
â”‚ ç¨‹åºå¡ä½      â”‚ strace -p, gdb attach, pstack                â”‚
â”‚ CPU é«˜        â”‚ top -Hp, perf record, ç«ç„°å›¾                  â”‚
â”‚ å†…å­˜æ³„æ¼      â”‚ valgrind, ASan, pmap, /proc/pid/smaps        â”‚
â”‚ å†…å­˜è¶Šç•Œ      â”‚ ASan, valgrind                                â”‚
â”‚ æ•°æ®ç«äº‰      â”‚ TSan, helgrind (valgrind)                     â”‚
â”‚ æ­»é”          â”‚ gdb thread apply all bt, pstack              â”‚
â”‚ ç£ç›˜ IO æ…¢    â”‚ iostat, iotop, strace                        â”‚
â”‚ ç½‘ç»œä¸é€š      â”‚ ping, ss, tcpdump, iptables                  â”‚
â”‚ æ–‡ä»¶æè¿°ç¬¦     â”‚ lsof -p, /proc/pid/fd                        â”‚
â”‚ ç³»ç»Ÿè°ƒç”¨è¿½è¸ª   â”‚ strace, ltrace                               â”‚
â”‚ å†…æ ¸è¿½è¸ª      â”‚ ftrace, bpftrace                             â”‚
â”‚ æ€§èƒ½æ€»è§ˆ      â”‚ perf stat (IPC, cache miss)                   â”‚
â”‚ å‡½æ•°çƒ­ç‚¹      â”‚ perf record + perf report                    â”‚
â”‚ å…¨å±€æ¦‚è§ˆ      â”‚ dstat, vmstat, sar                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é¢è¯•å£è¯€é€Ÿè®°

```
æ–‡ä»¶ä¸‰å±‚è¡¨ï¼šfdè¡¨ â†’ fileè¡¨ â†’ inodeè¡¨
é›¶æ‹·è´ä¸‰å‰‘å®¢ï¼šmmapã€sendfileã€splice
ä¿¡å·å¤„ç†ç”¨ sigactionï¼Œsignal ä¸å¯é 
fork ç”¨ COWï¼Œåªåœ¨å†™æ—¶å¤åˆ¶
daemon åŒ fork åŠ  setsid

GDB å››æ­¥èµ°ï¼šæ–­ç‚¹ â†’ è¿è¡Œ â†’ çœ‹æ ˆ â†’ æŸ¥å˜é‡
core dump ä¸‰æ­¥ï¼šå¼€ ulimit â†’ å¤ç° â†’ bt çœ‹æ ˆ
æ­»é”çœ‹ thread apply all bt

Valgrind å…¨ä½†æ…¢ï¼ŒASan å¿«è¦ç¼–è¯‘
TSan æŸ¥ç«æ€ï¼ŒUBSan æŸ¥æœªå®šä¹‰

ç¨‹åºå¡ä½ç”¨ strace
CPU é«˜ç”¨ perf ç”»ç«ç„°å›¾
å†…å­˜æ¶¨ç”¨ valgrind æˆ– jemalloc prof
IO æ…¢ç”¨ iostat + iotop
ç½‘ç»œé—®é¢˜åˆ†å±‚æŸ¥ï¼Œtcpdump æ˜¯æœ€åæ­¦å™¨
```

---

*è¿™ç¯‡æ–‡ç« è¦†ç›–äº† Linux ç³»ç»Ÿç¼–ç¨‹ä¸è°ƒè¯•çš„æ ¸å¿ƒçŸ¥è¯†ç‚¹ã€‚å»ºè®®åœ¨é¢è¯•å‰ï¼Œè‡³å°‘åœ¨è™šæ‹Ÿæœºé‡Œ**äº²æ‰‹è·‘ä¸€éæ¯ä¸ªå·¥å…·**â€”â€”è¯»åéä¸å¦‚æ•²ä¸€éã€‚*
