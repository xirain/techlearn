<!-- Client-side Mermaid diagram rendering -->
<script>
  async function initMermaid() {
    // Shiki renders as <pre data-language="mermaid"><code>...</code></pre>
    const preBlocks = document.querySelectorAll('pre[data-language="mermaid"]');
    if (preBlocks.length === 0) return;

    const { default: mermaid } = await import("https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs");

    // Detect theme
    const isDark = document.documentElement.classList.contains("theme-dark");
    mermaid.initialize({
      startOnLoad: false,
      theme: isDark ? "dark" : "default",
    });

    for (const pre of preBlocks) {
      const code = pre.querySelector("code");
      const text = code?.textContent || pre.textContent || "";

      const container = document.createElement("div");
      container.className = "mermaid-diagram my-6 flex justify-center overflow-x-auto";

      const id = `mermaid-${Math.random().toString(36).slice(2, 9)}`;
      try {
        const { svg } = await mermaid.render(id, text);
        container.innerHTML = svg;
        pre.replaceWith(container);
      } catch (e) {
        console.error("Mermaid render error:", e);
      }
    }
  }

  initMermaid();
  document.addEventListener("astro:after-swap", initMermaid);
</script>
